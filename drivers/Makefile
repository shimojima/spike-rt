#  SPDX-License-Identifier: MIT
#
#  Makefile for driver.
#
#  Copyright (C) 2022-2023 by Embedded and Real-Time Systems Laboratory,
#          		Graduate School of Information Science, Nagoya Univ., JAPAN

#
#  Definition for Newlib.
#
SYSSVC_COBJS += newlib_stub.o

#
#  Definitions for Pybricks Task.
#
KERNEL_DIRS += $(DRIVERS_DIR)

#
#  Definitions for Pybricks-C.
#
KERNEL_DIRS += $(DRIVERS_DIR)/pybricks-c \
							 $(DRIVERS_DIR)/pybricks-c/common
KERNEL_COBJS += pb_type_system.o pb_type_motor.o pb_type_dcmotor.o

#
#  Definitions for SPIKE API.
#
KERNEL_DIRS += $(DRIVERS_DIR)/spike \
							 $(DRIVERS_DIR)/spike/hub \
							 $(DRIVERS_DIR)/spike/pup

KERNEL_COBJS += system.o light.o display.o display_fonts.o button.o battery.o imu.o speaker.o bluetooth.o
KERNEL_COBJS += pup_device.o ultrasonicsensor.o colorsensor.o forcesensor.o motor.o

INCLUDES += -I$(DRIVERS_DIR) \
						-I$(DRIVERS_DIR)/spike \
						-I$(DRIVERS_DIR)/include

#
#  Definitions for Pybricks.
#
ifdef KERNEL_LIB
	PYBRICKS_OBJDIR ?= $(KERNEL_LIB)/../obj-primehub_pybricks
else
	PYBRICKS_OBJDIR ?= ../obj-primehub_pybricks
endif

include $(EXTERNAL_DIR)/pybricks.mk

INCLUDES +=  $(PYBRICKS_INCLUDES)
LIBS += $(PYBRICKS_LIB) -lm

#
#  pybricks.c has to be compiled after TOPPERS configurator (asp3/cfg/cfg.rb) has been executed
#  because it depends on kernel_cfg.h generated by the configurator.
#  So include pybricks.o in SYSSVC_COBJS not KERNEL_COBJS,
#  so that pybricks.c is compiled while application building.
#
SYSSVC_COBJS += pybricks.o


#
#  Definitions for Serial.
#
KERNEL_DIRS += $(DRIVERS_DIR)/serial


#
#  Definitions for TLSF.
#
include $(DRIVERS_DIR)/tlsf.mk
KERNEL_DIRS += $(TLSF_DIR)
KERNEL_COBJS += $(TLSF_COBJS)
INCLUDES +=  $(TLSF_INCLUDES)
